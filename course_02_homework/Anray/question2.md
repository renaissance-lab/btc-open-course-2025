# Bitcoin锁定脚本（scriptPubKey）比较分析

## 概述

锁定脚本（ScriptPubKey）是比特币交易输出中定义如何花费该输出的脚本。不同的地址格式对应不同的锁定脚本类型，每种都有其独特的结构、长度和功能特点。

## 1. Legacy锁定脚本

### P2PKH（Pay-to-Public-Key-Hash）

**脚本结构：**
```
OP_DUP OP_HASH160 <pubKeyHash> OP_EQUALVERIFY OP_CHECKSIG
```

**长度：** 25字节

**十六进制示例：**
```
76a914389ffce9cd9ae88dcc0631e88a821ffdbe9bfe2615488ac
```

**脚本分解：**
- `76` - OP_DUP
- `a9` - OP_HASH160
- `14` - 推送20字节数据
- `389ffce9cd9ae88dcc0631e88a821ffdbe9bfe26154` - 公钥哈希（20字节）
- `88` - OP_EQUALVERIFY
- `ac` - OP_CHECKSIG

### P2SH（Pay-to-Script-Hash）

**脚本结构：**
```
OP_HASH160 <scriptHash> OP_EQUAL
```

**长度：** 23字节

**十六进制示例：**
```
a91454a4f3e86ff8a8b8b1b3e8c5c9b7d6e5f4e3d2c187
```

**脚本分解：**
- `a9` - OP_HASH160
- `14` - 推送20字节数据
- `54a4f3e86ff8a8b8b1b3e8c5c9b7d6e5f4e3d2c1` - 脚本哈希（20字节）
- `87` - OP_EQUAL

## 2. SegWit锁定脚本

### P2WPKH（Pay-to-Witness-Public-Key-Hash）

**脚本结构：**
```
OP_0 <pubKeyHash>
```

**长度：** 22字节

**十六进制示例：**
```
0014389ffce9cd9ae88dcc0631e88a821ffdbe9bfe26154
```

**脚本分解：**
- `00` - OP_0（见证版本0）
- `14` - 推送20字节数据
- `389ffce9cd9ae88dcc0631e88a821ffdbe9bfe26154` - 公钥哈希（20字节）

### P2WSH（Pay-to-Witness-Script-Hash）

**脚本结构：**
```
OP_0 <scriptHash>
```

**长度：** 34字节

**十六进制示例：**
```
00201863143c14c5166804bd19203356da136c985678cd4d27a1b8c6329604903262
```

**脚本分解：**
- `00` - OP_0（见证版本0）
- `20` - 推送32字节数据
- `1863143c14c5166804bd19203356da136c985678cd4d27a1b8c6329604903262` - 脚本哈希（32字节）

## 3. Taproot锁定脚本

### P2TR（Pay-to-Taproot）

**脚本结构：**
```
OP_1 <tweakedPubKey>
```

**长度：** 34字节

**十六进制示例：**
```
5120a60869f0dbcf1dc659c9cecbaf8050135ea9e8cdc487053f1dc6880949dc684c
```

**脚本分解：**
- `51` - OP_1（见证版本1）
- `20` - 推送32字节数据
- `a60869f0dbcf1dc659c9cecbaf8050135ea9e8cdc487053f1dc6880949dc684c` - 调整后的公钥（32字节）

## 锁定脚本对比表

| 脚本类型 | 长度（字节） | 见证版本 | 哈希算法 | 主要特点 |
|----------|-------------|----------|----------|----------|
| P2PKH | 25 | - | HASH160 | 传统单签名 |
| P2SH | 23 | - | HASH160 | 脚本哈希 |
| P2WPKH | 22 | 0 | HASH160 | SegWit单签名 |
| P2WSH | 34 | 0 | SHA256 | SegWit脚本哈希 |
| P2TR | 34 | 1 | - | Taproot |

## 主要区别分析

### 1. 脚本长度差异
- **最短**：P2WPKH（22字节）
- **中等**：P2SH（23字节）、P2PKH（25字节）
- **最长**：P2WSH和P2TR（34字节）

### 2. 见证数据处理
- **Legacy**：所有数据在主交易中，无见证数据
- **SegWit**：签名和公钥在见证数据中，减少主交易大小
- **Taproot**：见证数据更加灵活，支持复杂脚本

### 3. 哈希算法
- **Legacy/SegWit v0**：使用HASH160（RIPEMD160(SHA256())）
- **SegWit v0 WSH**：使用SHA256
- **Taproot**：使用Schnorr签名和MAST

### 4. 脚本执行效率

#### Legacy脚本执行
```
解锁脚本 + 锁定脚本 → 栈操作 → 验证结果
```

#### SegWit脚本执行
```
见证数据 + 锁定脚本 → 分离验证 → 结果
```

#### Taproot脚本执行
```
密钥路径：直接Schnorr签名验证
脚本路径：MAST + 见证数据验证
```

### 5. 隐私和效率特点

**Legacy（P2PKH/P2SH）**
- 脚本类型完全暴露
- 较高的交易费用
- 简单的验证逻辑

**SegWit（P2WPKH/P2WSH）**
- 见证数据分离，降低费用
- 解决交易延展性问题
- 支持更复杂的脚本

**Taproot（P2TR）**
- 所有输出看起来相同
- 最优的隐私保护
- 支持复杂智能合约
- 量子抗性准备

### 6. 费用计算差异

**Legacy交易费用：**
```
费用 = (输入大小 + 输出大小) × 费率
```

**SegWit交易费用：**
```
费用 = (基础大小 × 4 + 见证大小) ÷ 4 × 费率
```

**Taproot交易费用：**
```
密钥路径：最小见证数据，最低费用
脚本路径：按实际使用的脚本计算
```

## 实际应用建议

### 1. 选择原则
- **简单转账**：优先使用P2WPKH
- **多重签名**：使用P2WSH或P2TR
- **兼容性要求**：使用P2SH包装
- **隐私要求**：使用P2TR

### 2. 开发注意事项
- 正确处理见证数据
- 注意脚本大小限制
- 考虑网络兼容性
- 优化交易费用

## 结论

比特币锁定脚本的演进体现了网络在效率、隐私和功能性方面的不断改进。从Legacy的简单直接，到SegWit的见证分离，再到Taproot的隐私保护和智能合约支持，每种脚本类型都有其适用场景。开发者应根据具体需求选择合适的脚本类型，平衡功能需求、费用成本和兼容性要求。